<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isModify} ? '회원정보 수정' : '회원가입'">회원가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/joinmember.css}">

    <!-- 수정 모드 데이터 전달 -->
    <script th:inline="javascript" th:if="${isModify}">
        /*<![CDATA[*/
        window.memberData = {
            info: /*[[${info}]]*/ null,
            isModify: /*[[${isModify}]]*/ false
        };
        /*]]>*/
    </script>

    <script type="text/javascript" th:src="@{/js/member/join.js}"></script>
    <script type="text/javascript" th:src="@{/js/member/login.js}"></script>
</head>
<body>

<div class="container">
    <!-- header -->
    <div id="header">
        <h1 class="join_title">
            <label><strong th:text="${isModify} ? '회원정보 수정' : '회원가입'">회원가입</strong></label>
        </h1>
        <h3 th:text="${isModify} ? '정보를 수정해주세요.' : 'Welcome! 집콕에 오신 것을 환영합니다.'">Welcome! 집콕에 오신 것을 환영합니다.</h3>
    </div>

    <!-- wrapper in -->
    <div id="wrapper">

        <!-- content in -->
        <div id="content">

            <!-- form in -->
            <form name="joinForm"
                  method="post"
                  onsubmit="return joinValidate(this);"
                  enctype="multipart/form-data"
                  th:action="${isModify} ? '@{/member/modify/action}' : '@{/member/join/action}'">

                <!-- 회원 유형 선택 (수정 모드에서는 숨김) -->
                <div th:unless="${isModify}"
                     style="margin-bottom: 30px; text-align: center; padding: 20px; border: 2px solid #ddd; border-radius: 10px;">
                    <h3 class="join_title" style="margin-bottom: 20px;">가입 유형을 선택해주세요</h3>
                    <label style="margin-right: 30px; font-size: 18px;">
                        <input type="radio" name="memberStatus" value="1" onchange="toggleMemberType()" checked>
                        &nbsp;<strong>일반 사용자</strong>
                    </label>
                    <label style="font-size: 18px;">
                        <input type="radio" name="memberStatus" value="2" onchange="toggleMemberType()">
                        &nbsp;<strong>셔틀콕 (헬퍼)</strong>
                    </label>
                </div>

                <!-- 수정 모드에서는 hidden으로 회원 유형 전달 -->
                <input type="hidden"
                       name="memberStatus"
                       th:if="${isModify}"
                       th:value="${info?.memberStatus}">
                <input type="hidden"
                       name="memberSeq"
                       th:if="${isModify}"
                       th:value="${info?.memberSeq}">

                <!-- NAME -->
                <div>
                    <h3 class="join_title">
                        <label for="name">이름</label>
                    </h3>
                    <span class="box int_name">
                        <input type="text"
                               id="name"
                               class="join_H"
                               maxlength="20"
                               name="memberName"
                               th:value="${info?.memberName}"
                               required>
                    </span> <span class="error_next_box"></span>
                </div>

                <!-- ID -->
                <div>
                    <h3>아이디</h3>
                    <div class="box int_id">
                        <input type="text"
                               id="memberId"
                               name="memberId"
                               class="join_H"
                               placeholder="아이디 입력"
                               th:value="${info?.memberId}"
                               th:readonly="${isModify}"
                               th:style="${isModify} ? 'background-color: #f5f5f5; cursor: not-allowed;' : ''">
                    </div>
                    <span id="idCheckMsg"
                          class="error_next_box"
                          th:style="${isModify} ? 'display: none;' : ''"></span>
                    <input type="hidden"
                           name="idDuplication"
                           th:value="${isModify} ? 'idCheck' : 'idUncheck'">
                </div>

                <!-- pass1 -->
                <div>
                    <h3 class="join_title">
                        <label for="memberPass"
                               th:text="${isModify} ? '비밀번호 (변경시에만 입력)' : '비밀번호'">비밀번호</label>
                    </h3>
                    <span class="box int_pass">
                        <input type="password"
                               id="memberPass"
                               class="join_H"
                               maxlength="16"
                               name="memberPass"
                               th:placeholder="${isModify} ? '변경하려면 입력하세요' : '비밀번호를 입력하세요'"
                               th:required="${!isModify}">
                        <span id="alertTxt">사용불가</span>
                        <img th:src="@{/img/login/m_icon_pass.png}" id="pass1_img" class="passImg">
                    </span> <span class="error_next_box"></span>
                </div>

                <!-- pass2 -->
                <div>
                    <h3 class="join_title">
                        <label for="memberPass2">비밀번호 확인</label>
                    </h3>
                    <span class="box int_pass_check">
                        <input type="password"
                               id="memberPass2"
                               class="join_H"
                               maxlength="16"
                               name="memberPass2"
                               th:placeholder="${isModify} ? '변경하려면 다시 입력하세요' : '비밀번호를 다시 입력하세요'"
                               th:required="${!isModify}">
                        <img th:src="@{/img/login/m_icon_check_disable.png}" id="pass2_img" class="passImg">
                    </span> <span class="error_next_box"></span>
                </div>

                <!-- Email -->
                <div>
                    <h3 class="join_title">
                        <label>이메일</label>
                    </h3>
                    <span class="box_email">
                        <input type="text"
                               id="email_1"
                               class="join_email"
                               maxlength="20"
                               name="email_1"
                               th:value="${info?.memberEmail != null} ? ${#strings.substringBefore(info.memberEmail, '@')} : ''"
                               required>
                    </span>
                    &nbsp;@
                    <span class="box_email">
                        <input type="text"
                               id="email_2"
                               class="join_email"
                               maxlength="20"
                               name="email_2"
                               th:value="${info?.memberEmail != null} ? ${#strings.substringAfter(info.memberEmail, '@')} : ''"
                               style="width:20%"
                               readonly
                               required>
                    </span>
                    &nbsp;
                    <span class="box_email">
                        <select name="email_check"
                                onchange="email_input(this.form);"
                                class="join_email"
                                id="email_check"
                                style="width:20%"
                                required>
                            <option value="">-선택-</option>
                            <option value="1">직접입력</option>
                            <option value="gmail.com" th:selected="${info?.memberEmail != null and #strings.contains(info.memberEmail, 'gmail.com')}">gmail.com</option>
                            <option value="naver.com" th:selected="${info?.memberEmail != null and #strings.contains(info.memberEmail, 'naver.com')}">naver.com</option>
                            <option value="daum.net" th:selected="${info?.memberEmail != null and #strings.contains(info.memberEmail, 'daum.net')}">daum.net</option>
                            <option value="kakao.com" th:selected="${info?.memberEmail != null and #strings.contains(info.memberEmail, 'kakao.com')}">kakao.com</option>
                        </select>
                    </span> <span class="error_next_box"></span>
                </div>

                <!-- age -->
                <div>
                    <h3 class="join_title">
                        <label for="age">나이 / 성별</label>
                    </h3>
                    <div id="age_wrap">

                        <div id="age">
                            <span class="box">
                                <select id="age_check" class="sel" name="memberAge" required>
                                    <option value="">나이</option>
                                    <option value="10" th:selected="${info?.memberAge == '10'}">10대</option>
                                    <option value="20" th:selected="${info?.memberAge == '20'}">20대</option>
                                    <option value="30" th:selected="${info?.memberAge == '30'}">30대</option>
                                    <option value="40" th:selected="${info?.memberAge == '40'}">40대</option>
                                    <option value="50" th:selected="${info?.memberAge == '50'}">50대</option>
                                    <option value="60" th:selected="${info?.memberAge == '60'}">60대</option>
                                    <option value="0" th:selected="${info?.memberAge == '0'}">기타</option>
                                </select>
                            </span>
                        </div>

                        <!-- GENDER -->
                        <div id="gender">
                            <span class="box gender_code">
                                <select id="memberGender" class="sel" name="memberGender" required>
                                    <option value="">성별</option>
                                    <option value="0" th:selected="${info?.memberGender == 0}">남자</option>
                                    <option value="1" th:selected="${info?.memberGender == 1}">여자</option>
                                </select>
                            </span>
                            <span class="error_next_box">필수 정보입니다.</span>
                        </div>

                    </div>

                    <span class="error_next_box"></span>
                </div>

                <!-- phone -->
                <div>
                    <h3 class="join_title">
                        <label for="phone">휴대전화</label>
                    </h3>
                    <span class="box int_phone">
                        <input type="text"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                               id="phone"
                               class="join_H"
                               maxlength="11"
                               placeholder="휴대전화 입력"
                               name="memberPhone"
                               th:value="${info?.memberPhone}"
                               required>
                        <span class="step_url">'-' 생략</span>
                    </span> <span class="error_next_box"></span>
                </div>

                <!-- 헬퍼 전용 필드들 -->
                <div id="helper_fields"
                     th:style="${info?.memberStatus == 2} ? 'display: block;' : 'display: none;'">

                    <!-- bank -->
                    <div>
                        <h3 class="join_title">
                            <label for="bank">입금계좌 은행</label>
                        </h3>
                        <div id="bank_wrap">
                            <div id="bank">
                                <span class="box">
                                    <select id="memberBank" class="sel" name="memberBank" onchange="input_bank(this.form)">
                                        <option value="">은행선택</option>
                                        <option value="기업은행" th:selected="${info?.memberBank == '기업은행'}">기업은행</option>
                                        <option value="국민은행" th:selected="${info?.memberBank == '국민은행'}">국민은행</option>
                                        <option value="우리은행" th:selected="${info?.memberBank == '우리은행'}">우리은행</option>
                                        <option value="신한은행" th:selected="${info?.memberBank == '신한은행'}">신한은행</option>
                                        <option value="하나은행" th:selected="${info?.memberBank == '하나은행'}">하나은행</option>
                                        <option value="농협은행" th:selected="${info?.memberBank == '농협은행'}">농협은행</option>
                                        <option value="SC은행" th:selected="${info?.memberBank == 'SC은행'}">SC은행</option>
                                        <option value="카카오뱅크" th:selected="${info?.memberBank == '카카오뱅크'}">카카오뱅크</option>
                                    </select>
                                </span> <span class="error_next_box">하나는 필수 선택.</span>
                            </div>
                        </div>
                    </div>

                    <!-- account -->
                    <div>
                        <h3 class="join_title">
                            <label for="account">계좌번호</label>
                        </h3>
                        <span class="box int_phone">
                            <input type="text"
                                   id="account"
                                   class="join_H"
                                   maxlength="30"
                                   placeholder="계좌번호 입력"
                                   name="memberAccount"
                                   th:value="${info?.memberAccount}"
                                   th:readonly="${info?.memberBank == null or info?.memberBank == ''}">
                            <span class="step_url">'-' 생략</span>
                        </span> <span class="error_next_box"></span>
                    </div>

                    <!-- vehicle -->
                    <div>
                        <h3 class="join_title">
                            <label for="vehicle">보유중인 주요 이동수단</label>
                        </h3>
                        <div id="vehicle_wrap">
                            <div id="vehicle">
                                <span class="box">
                                    <label><input type="radio" value="0" name="memberVehicle" th:checked="${info?.memberVehicle == 0 or info?.memberVehicle == null}">&nbsp;자동차&nbsp;</label>
                                    <label><input type="radio" value="1" name="memberVehicle" th:checked="${info?.memberVehicle == 1}">&nbsp;오토바이&nbsp;</label>
                                    <label><input type="radio" value="2" name="memberVehicle" th:checked="${info?.memberVehicle == 2}">&nbsp;자전거&nbsp;</label>
                                    <label><input type="radio" value="3" name="memberVehicle" th:checked="${info?.memberVehicle == 3}">&nbsp;도보&nbsp;</label>
                                    <label><input type="radio" value="4" name="memberVehicle" th:checked="${info?.memberVehicle == 4}">&nbsp;기타&nbsp;</label>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- introduce -->
                    <div>
                        <h3 class="join_title">
                            <label for="memberIntroduce">자기소개</label>
                        </h3>
                        <span class="box int_address">
                            <input type="text"
                                   id="memberIntroduce"
                                   class="join_H"
                                   maxlength="20"
                                   placeholder="20자 이내 입력"
                                   name="memberIntroduce"
                                   th:value="${info?.memberIntroduce}">
                        </span> <span class="error_next_box"></span>
                    </div>

                    <!-- picture -->
                    <div>
                        <h3 class="join_title"><label>프로필사진</label></h3>
                        <span class="box int_picture">
                            <!-- 기존 프로필 사진 표시 (수정 모드) -->
                            <div th:if="${isModify and info.getFullImageName != null}" class="current-image">
                                <img th:src="@{${info.imageUrl}}"
                                     alt="현재 프로필"
                                     style="max-width: 100px; max-height: 100px; margin-bottom: 10px;">
                                <p>현재 프로필: <span th:text="${info.getFullImageName}"></span></p>
                            </div>
                            <input type="file"
                                   name="attachFile"
                                   id="attachFile"
                                   accept="image/png, image/jpeg">
                            <small th:if="${isModify}">새 이미지를 선택하면 기존 이미지가 교체됩니다.</small>
                        </span>
                    </div>

                    <!-- 헬퍼 통계 정보 (수정 모드에서만 표시) -->
                    <!--<div th:if="${isModify}" class="helper-stats" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                        <h4>헬퍼 활동 정보</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;" th:text="${info?.memberReview ?: 0}">0</div>
                                <div style="font-size: 14px; color: #666;">리뷰 수</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;" th:text="${info?.memberMissionC ?: 0}">0</div>
                                <div style="font-size: 14px; color: #666;">완료 미션</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;" th:text="${info?.memberPoint ?: 0}">0</div>
                                <div style="font-size: 14px; color: #666;">보유 포인트</div>
                            </div>
                        </div>
                    </div>-->

                </div>
                <!-- 헬퍼 전용 필드 끝 -->

                <!-- JOIN BTN-->
                <div class="btn_area">
                    <button type="submit" class="joinBtn">
                        <span th:text="${isModify} ? '정보 수정' : '가입하기'">가입하기</span>
                    </button>
                    <button type="button"
                            th:if="${isModify}"
                            class="mt-3 joinBtn"
                            style="background-color: #6c757d;"
                            onclick="cancelModify()">
                        <span>취소</span>
                    </button>
                </div>

            </form>
            <!-- form out -->

        </div>
        <!-- content-->

    </div>
    <!-- wrapper -->

</div>

<script>
    function cancelModify() {
        if (confirm('수정을 취소하고 마이페이지로 돌아가시겠습니까?')) {
            window.location.href = '/zipkok/member/mypage';
        }
    }

    // 수정 모드일 때 추가 설정
    document.addEventListener('DOMContentLoaded', function() {
        if (window.memberData && window.memberData.isModify) {
            // 회원 유형에 따른 헬퍼 필드 표시
            const memberStatus = window.memberData.info.memberStatus;
            if (memberStatus === 2) {
                document.getElementById('helper_fields').style.display = 'block';
            }

            // 은행이 선택되어 있으면 계좌번호 입력 활성화
            const bankSelect = document.getElementById('memberBank');
            const accountInput = document.getElementById('account');
            if (bankSelect && bankSelect.value && accountInput) {
                accountInput.readOnly = false;
            }
        }
    });
</script>

</body>
</html>