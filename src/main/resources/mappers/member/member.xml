<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//com.kosmo.zipkok.mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kosmo.zipkok.dao.MemberDAO">
	
	<select id="selectEmail" parameterType="java.lang.String" resultType="boolean">
		SELECT
		    CASE
				WHEN COUNT(MEMBER_SEQ) > 0 THEN 1
			ELSE 0
			END AS exists_flag
		FROM
		    MEMBER
		WHERE
		    MEMBER_EMAIL = #{member_email}
	</select>

	<select id="selectMemberById" parameterType="java.lang.String" resultType="HelperDTO">
		SELECT
			M.member_seq AS memberSeq,
			M.member_id AS memberId,
			M.member_pass AS memberPass,
			M.member_name AS memberName,
			M.member_email AS memberEmail,
			M.member_age AS memberAge,
			M.member_gender AS memberGender,
			M.member_phone AS memberPhone,
			NVL(M.member_missionN, 0) AS memberMissionN,
			M.member_status AS memberStatus,
			H.member_bank AS memberBank,
			H.member_account AS memberAccount,
			H.member_vehicle AS memberVehicle,
			H.member_introduce AS memberIntroduce,
			H.member_review AS memberReview,
			NVL(H.member_missionC, 0) AS memberMissionC,
			NVL(H.member_point, 0) AS memberPoint,
			IMG.image_name AS imageFileName,
			IMG.image_etx AS imageFileEtx,
			IMG.image_file AS imageFile
		FROM
			MEMBER M
		LEFT JOIN HELPER H
		ON M.member_seq = H.member_seq
		LEFT JOIN HELPER_IMAGE IMG
		ON H.member_seq = IMG.member_seq
		WHERE
		    MEMBER_ID =#{memberId}
	</select>


	<select id="idCheck" resultType="java.lang.String">
		SELECT
			member_id AS memberId
		FROM
			member
		WHERE
			member_id = #{memberId}
	</select>

	<select id="findId" parameterType="Map" resultType="java.lang.String">
		SELECT
			member_id AS memberId
		FROM
			member
		WHERE
			member_name = #{name}
		AND member_email = #{email}
	</select>

	<select id="findPwd" parameterType="Map" resultType="java.lang.String">
		SELECT
			member_pass AS memberPass
		FROM
			member
		WHERE
			member_id = #{mid}
		AND member_name = #{name}
		AND member_email = #{email}
	</select>

	<!-- 사용자 등록 -->
	<insert id="insertMember" parameterType="HelperDTO" useGeneratedKeys="true" keyProperty="memberSeq">
		INSERT INTO MEMBER
		    (
		    	MEMBER_ID,
		     	MEMBER_PASS,
		     	MEMBER_NAME,
		     	MEMBER_EMAIL,
		     	MEMBER_AGE,
		     	MEMBER_GENDER,
		     	MEMBER_PHONE,
		     	MEMBER_STATUS,
		     	CREATE_DT
			)
		VALUES
		    (
				#{memberId},
		    	#{memberPass},
		    	#{memberName},
		    	#{memberEmail},
				#{memberAge},
		    	#{memberGender},
				#{memberPhone},
				#{memberStatus},
		     	NOW()
			)
	</insert>

	<!-- 헬퍼 등록-->
	<insert id="insertHelper" parameterType="HelperDTO">
		INSERT INTO HELPER
			(
			 	MEMBER_SEQ,
				MEMBER_BANK,
			 	MEMBER_ACCOUNT,
			 	MEMBER_VEHICLE,
				MEMBER_INTRODUCE
			)
		VALUES
		    (
		     	#{memberSeq},
				#{memberBank},
		    	#{memberAccount},
		    	#{memberVehicle},
				#{memberIntroduce}
			)
	</insert>

	<insert id="insertHelperImage" parameterType="HelperDTO">
		INSERT INTO HELPER_IMAGE
			(
				MEMBER_SEQ,
				IMAGE_NAME,
			 	IMAGE_ETX,
				IMAGE_FILE,
				CREATE_DT
			)
		VALUES
			(
				#{memberSeq},
				#{imageFileName},
				#{imageFileEtx},
				#{imageFile},
				NOW()
			)
	</insert>

	<!-- 사용자 수정-->
	<update id="updateMember" parameterType="HelperDTO" useGeneratedKeys="true" keyProperty="memberSeq">
		UPDATE MEMBER
		SET
			MEMBER_EMAIL = #{memberEmail},
			MEMBER_PHONE = #{memberPhone},
		<if test="memberPass != null and memberPass != ''">
			MEMBER_PASS = #{memberPass},
		</if>
			CREATE_DT = NOW()
		WHERE
		    MEMBER_ID = #{memberId}
	</update>

	<!-- 헬퍼 수정-->
	<update id="updateHelper" parameterType="HelperDTO">
		UPDATE HELPER
		SET
			MEMBER_BANK = #{memberBank},
			MEMBER_ACCOUNT = #{memberAccount},
			MEMBER_VEHICLE = #{memberVehicle},
			MEMBER_INTRODUCE = #{memberIntroduce}
		WHERE
			MEMBER_SEQ = #{memberSeq}
	</update>

	<update id="updateHelperImage" parameterType="HelperDTO">
		UPDATE HELPER_IMAGE
		SET
			IMAGE_NAME = #{imageFileName},
			IMAGE_ETX = #{imageFileEtx},
			IMAGE_FILE = #{imageFile},
			CREATE_DT = NOW()
		WHERE
			MEMBER_SEQ = #{memberSeq}
	</update>
	



	<!-- 카카오로그인시 가입여부 -->
	<select id="kakaoLogin" resultType="com.kosmo.zipkok.dto.MemberDTO">
		SELECT * FROM member WHERE member_id=#{0}
	</select>
	
	<!-- 회원탈퇴 -->
	<delete id="memberDelete" >
		DELETE FROM member
			WHERE member_id=#{param1} 
	</delete>

</mapper>

